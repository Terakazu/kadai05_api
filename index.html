<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/sample.css">

    <title>chatã‚¢ãƒ—ãƒª</title>
</head>
<body>
    <h1>ã”è¿‘æ‰€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h1>
    <p>è¡—ã®æƒ…å ±ã‚’å…±æœ‰ã—ã‚ˆã†ï¼</p>
    <img id="tsunashima" src="img/tsunashima_01.jpg">

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
<div class="main">
    <div class="content">åå‰ï¼š<input type="text" id="uname"></div>
    <div class="content">æœ¬æ–‡ï¼š
        <textarea id="text" cols="30" rows="10"></textarea><br>
        <button id="send">é€ä¿¡</button><br>
    </div>
    <div id="output" style="overflow: auto;height: 300px;">
    </div>
</div>

<div id="replyInput" style="display: none;">
  <div class="replyzone">
    <div>åå‰ï¼š<input type="text" id="uname2"></div>
    <div>
        <textarea id="text2" cols="30" rows="10"></textarea>
        <button id="reply2">é€ä¿¡</button>
        <button id="return">æˆ»ã‚‹</button>
    </div>
  </div>
   <div id="replyContainer" style="overflow: auto;height: 300px;"></div>
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç”¨ã®è¦ç´  -->

<!-- JQuery -->
<script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AvDpfP2mhgsjKyTdfNyWXKGmo72SBfCvqYwQEvHUoMp9VM138Li7MhHQnSgQoQif' async defer></script>
<script src="BmapQuery.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get , child, update, remove, onChildAdded, onChildChanged, onChildRemoved } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
import { getStorage, ref as storageRef, uploadBytes,getDownloadURL, getBlob } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

// Firebaseè¨­å®š
const firebaseConfig = {
    apiKey: "AIzaSyCjms3x3KlJRmCR03mMXGwmox2imjuxYQg",
    authDomain: "commonapli.firebaseapp.com",
    projectId: "commonapli",
    storageBucket: "commonapli.appspot.com",
    messagingSenderId: "955179997465",
    appId: "1:955179997465:web:b4c1f8155ee311256f4d88"
  };

const app= initializeApp(firebaseConfig);
const db = getDatabase(app); 
const dbRef = ref(db,"chat/message");

// æŠ•ç¨¿ãŒç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã©ã‚Œãã‚‰ã„å‰ã«è¡Œã‚ã‚ŒãŸã‹ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
function getTimeDifferenceString(postDate) {
    const now = new Date();
    const diffMilliseconds = now - postDate;
    const diffSeconds = Math.floor(diffMilliseconds / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffDays > 0) {
        return `${diffDays}æ—¥å‰`;
    } else if (diffHours > 0) {
        return `${diffHours}æ™‚é–“å‰`;
    } else if (diffMinutes > 0) {
        return `${diffMinutes}åˆ†å‰`;
    } else {
        return 'ãŸã£ãŸä»Š';
    }
}

// é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#send").on("click", function(){
    const msg = {
      uname : $("#uname").val(),
      text : $("#text").val(),
      timestamp : new Date().getTime(),
      likeCount: 0, // åˆæœŸã„ã„ã­æ•°ã‚’ä¿å­˜
      // picture :imageUrl
    } 
  const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
  set(newPostRef, msg);
});

// Firebaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†
onChildAdded(dbRef, function(data) {
    const msg = data.val();
    console.log(msg);
    const postDate = new Date(msg.timestamp); // Firebaseã‹ã‚‰å–å¾—ã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const timeDifferenceString = getTimeDifferenceString(postDate);
    const key =data.key;

    let h = '<p id="'+key+'">';
       h += `${msg.uname} (${timeDifferenceString})<br>`;
       h += '<span contentEditable="true" id="'+key+'_update">'+msg.text+'</span>';
       h += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
       h += `<span class="likeCount" data-key="'+key+'">0</span>`; // ã„ã„ã­ã®æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ‘ãƒ³è¦ç´ 
       h += '<button class="reply" data-key="'+key+'">è¿”ä¿¡</button>'; // è¿”ä¿¡ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
       h += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
       h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
       h += '</p>';
      //  h += '<button class="dl_button">File Download</button>';
      //  h += '<img class="myimg">';
       const $message = $(h);
       $("#output").prepend($message);
   

      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $("#uname").val("");
    $("#text").val("");
    $("#fileInput").val("");
});

// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".remove",function(){
  const key =$(this).attr("data-key");
  const remove_item =ref(db,"chat/message"+key);
  remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
});

// æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".update",function(){
  const key =$(this).attr("data-key");
  update(ref(db,"chat/message"+key), {
      text:$("#"+key+'_update').html()
  });
});

// ã„ã„ã­ã®æ›´æ–°
$("#output").on("click", ".likeCount", function() {
    const key = $(this).attr("data-key");
    
    // ã„ã„ã­ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ã—ã¦ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
    const likeCountRef = ref(db, "chat/message");
    get(likeCountRef).then((snapshot) => {
        const currentLikeCount = snapshot.val();
        const newLikeCount = currentLikeCount + 1;

        // Firebase Realtime Databaseã«ã„ã„ã­ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹
        update(ref(db, "chat/message"), {
            likeCount: newLikeCount
        }).then(() => {
            console.log("ã„ã„ã­ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
            // æ›´æ–°æˆåŠŸæ™‚ã®å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
        }).catch((error) => {
            console.error("ã„ã„ã­ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ 
        });
    });
});

// å‰Šé™¤å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildRemoved(dbRef,(data)=> {
  $("#"+data.key).remove();  //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
})

// æ›´æ–°å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildChanged(dbRef,(data)=>{
  $("#"+data.key+'_update').html(data.val().text);
  $("#"+data.key+'_update').fadeOut(800).fadeIn(800);
});

// è¿”ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".reply", function() {
    console.log("OK");

  const key = $(this).attr("data-key");
  $("#reply2").attr("data-key", key);
  
  // Firebase Realtime Databaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const dbRef = ref(getDatabase());

    // get(child(dbRef,key).then((snapshot) => {
    // if (snapshot.exists()) {
    //  console.log(snapshot.val());
    //  const msg =snapshot.val();
    //  const postDate = new Date(msg.timestamp);
    //  const timeDifferenceString = getTimeDifferenceString(postDate);
    //  let h = '<p id="'+key+'">';
    //    h += `${msg.uname} (${timeDifferenceString})<br>`;
    //    h += '<span contentEditable="true" id="'+key+'_update">'+msg.text+'</span>';
    //    h += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
    //    h += `<span class="likeCount" data-key="'+key+'">0</span>`; // ã„ã„ã­ã®æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ‘ãƒ³è¦ç´ 
    //    h += '<button class="reply" data-key="'+key+'">è¿”ä¿¡</button>'; // è¿”ä¿¡ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    //    h += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
    //    h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
    //    h += '</p>';
    //    const $message = $(h);
    //    $("#replyContainer").append($message);
    // } 
  
    
   
    $("#tsunashima").hide();
    $(".main").hide();
    $("#replyInput").show();
    
    });
// è¿”ä¿¡é€ä¿¡ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#reply2").on("click", function() {
    const key = $(this).attr("data-key");
    console.log(key);
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å–å¾—
    const uname = $("#uname2").val();
    const text = $("#text2").val();
    const replyData = {
        text: text,
        uname: uname,
        timestamp: new Date().getTime() // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¨­å®š
    };

    // Firebase Realtime Databaseã«è¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
    const replyRef = ref(db, `chat/message/${key}/replies`);
    const newReplyRef = push(replyRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ

    // è¿”ä¿¡ã‚’æŠ•ç¨¿ã®ä¸‹ã«ä¿å­˜ã™ã‚‹
    set(newReplyRef, replyData)
        .then(() => {
            console.log("è¿”ä¿¡ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
            // é€ä¿¡æˆåŠŸã®å ´åˆã€é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¿½åŠ 
        })
        .catch((error) => {
            console.error("è¿”ä¿¡ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¿½åŠ 
        });

      
// è¿”ä¿¡ã‚’è¡¨ç¤º
onChildAdded(replyRef, function(data) {
    const replyData = data.val();
    const postDate = new Date(replyData.timestamp); // Firebaseã‹ã‚‰å–å¾—ã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const timeDifferenceString = getTimeDifferenceString(postDate);
    const key = data.key;

        let h = '<p id="' + key + '">';
        h += `${replyData.uname} (${timeDifferenceString})<br>`;
        h += '<span contentEditable="true" id="' + key + '_update">' + replyData.text + '</span>';
        h += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
        h += `<span class="likeCount" data-key="${key}">0</span>`; // ã„ã„ã­ã®æ•°ã‚’è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ‘ãƒ³è¦ç´ 
        h += '<span class="remove" data-key="' + key + '">ğŸš®</span>'
        h += '<span class="update" data-key="' + key + '">ğŸ†™</span>'
        h += '</p>';
        const $message = $(h);
        $("#replyContainer").append($message);
        });
      }); 

  
// æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
$("#return").on("click",function(){
  $(".main").show();
  $("#replyInput").hide();
  $("#tsunashima").show();
  $("#output").show();

    })
</script>

<style>
    .likeButton {
        background-color: transparent;
        border: none;
        cursor: pointer;
        color: #0000FF;
        outline: none;
    }
    
    /* .likeButton.liked {
        color: #FF0000;
    } */
    </style> 

</body>
</html>