<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/sample.css">
    <title>ã”è¿‘æ‰€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
   
</head>
<body>

    <header>
       
    <h1>ã”è¿‘æ‰€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h1> 
    <p>è¡—ã®æƒ…å ±ã‚’å…±æœ‰ã—ã‚ˆã†ï¼</p>
    <!-- <img id="tsunashima" src="img/tsunashima_01.jpg"> -->
    </header>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->
     <!--MAPã‚’è¡¨ç¤ºã™ã‚‹ (headerå›ºå®š) -->
     <div id="geocode">â€»åœ°å›³ä¸Šã§å ´æ‰€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</div>
     <div id="myMap"
     style="position: relative; width: 100%; height: 450px;"></div>
     <!--MAP[END]-->
    <div class="container">
        <div class="main">
            <div class="content"> åå‰ ï¼š<input type="text" id="uname"></div>
            <div class="content"> ã‚³ãƒ¡ãƒ³ãƒˆ   ï¼š
                <textarea id="text" cols="30" rows="10"></textarea><br>
                <input type="file" id="fileInput"> 
                <!-- <form type="file" id="form">ãƒ•ã‚©ãƒ¼ãƒ </form>
                <button id="dl-button">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button> -->
                <img id="preview" src="" style="display: none;"> 
                <button id="send">é€ä¿¡</button><br>
            </div>
         </div>
    </div>
    
    
    <div id="output" style="overflow: auto;height: 1000px;">
 
    </div>
</div>

<div id="replyInput" style="display: none;">
  <div class="replyzone">
    <div>åå‰ï¼š<input type="text" id="uname2"></div>
    <div>
        <textarea id="text2" cols="30" rows="10"></textarea>
       
        <button id="reply2">é€ä¿¡</button>
        <button id="return">æˆ»ã‚‹</button>
    </div>
  </div>
   <div id="replyContainer" style="overflow: auto;height: 1000px;"></div>
</div>

<!-- ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºç”¨ã®è¦ç´  -->

<!-- JQuery -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getDatabase, ref, onValue, push, set, get , child, update, remove, onChildAdded, onChildChanged, onChildRemoved,runTransaction } 
from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
import { getStorage, ref as storageRef ,uploadBytes,getDownloadURL, getBlob } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";



const app= initializeApp(firebaseConfig);
const db = getDatabase(app); 
const dbRef = ref(db,"chat/message");
const storage = getStorage(app);
const inputRef = document.querySelector("#fileInput");
const formRef = document.querySelector("#form");


// æŠ•ç¨¿ãŒç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã©ã‚Œãã‚‰ã„å‰ã«è¡Œã‚ã‚ŒãŸã‹ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
function getTimeDifferenceString(postDate) {
    const now = new Date();
    const diffMilliseconds = now - postDate;
    const diffSeconds = Math.floor(diffMilliseconds / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffDays > 0) {
        return `${diffDays}æ—¥å‰`;
    } else if (diffHours > 0) {
        return `${diffHours}æ™‚é–“å‰`;
    } else if (diffMinutes > 0) {
        return `${diffMinutes}åˆ†å‰`;
    } else {
        return 'ãŸã£ãŸä»Š';
    }
}

// "fileInput" ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
$("#fileInput").on("change", async function() {
    // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    const file = this.files[0];
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãŸã‚ã®å‡¦ç†
    const reader = new FileReader();
    reader.onload = function(e) {
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®è¦ç´ ã«ç”»åƒã‚’è¡¨ç¤º
        $("#preview").attr("src", e.target.result);
    };
    reader.readAsDataURL(file);
    $("#preview").show();
});

const bucketName = "gs://commonapli.appspot.com"; // Firebase Storageã®ãƒã‚±ãƒƒãƒˆåã‚’è¨­å®š
const handleSubmit = async () => {
  const file = inputRef.files[0];
  if (!file) {
        console.log("No file selected.");
        return null; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯nullã‚’è¿”ã™
  }

  const ext = file.name.split(".").pop();
  const fileName = `${Date.now()}.${ext}`;
  const filePath = `images/${fileName}`;
  console.log(filePath);
  const fileRef = storageRef(storage, filePath);
  console.log(fileRef);
  await uploadBytes(fileRef, file);
  console.log("Uploaded a blob or file!");

  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿”ã™
  return fileName;

};

// formRef.addEventListener("click", handleSubmit);

const buttonRef = document.querySelector("#dl-button");
const imageRef = document.querySelector("#img");

const handleDownload = async () => {
  const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
  const fileRef = storageRef(storage, `images/${fileName}`);
  const url = await getDownloadURL(fileRef);
  console.log(url);


};

// buttonRef.addEventListener("click", handleDownload);

// é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#send").on("click",async function(){
   const aa =JSON.parse(localStorage.getItem("map"))
   console.log(aa,"ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸");

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±ã‚’å–å¾—
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(async function(data) {
            // const lat = data.coords.latitude;
            // const lon = data.coords.longitude;
            // console.log(lat,lon,"é€ä¿¡");

            // ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã¨åŒæ§˜ã«ã€ä½ç½®æƒ…å ±ã‚’å«ã‚ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            const fileName = await handleSubmit(); // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            let imageURL = null;
            if (fileName) {
                const fileRef = storageRef(storage, `images/${fileName}`);
                imageURL = await getDownloadURL(fileRef);
            }
   
    
    const msg = {
        uname: $("#uname").val(),
        text: $("#text").val(),
        timestamp: new Date().getTime(),
        likeCount: 0,
        imageURL: imageURL, // imageURL ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« URL ã‚’è¿½åŠ 
        latitude: aa.lat, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¯åº¦ã‚’è¿½åŠ 
        longitude: aa.lon // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµŒåº¦ã‚’è¿½åŠ 
    };

    const newPostRef = push(dbRef);
    set(newPostRef, msg); // ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ Realtime Database ã«ä¿å­˜
});
} else {
        console.log("Geolocation is not supported by this browser.");
}
});

// Firebaseã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¦è¡¨ç¤ºã™ã‚‹å‡¦ç†
onChildAdded(dbRef, function(data) {
    const msg = data.val();
    console.log(msg);
    const postDate = new Date(msg.timestamp); // Firebaseã‹ã‚‰å–å¾—ã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    const timeDifferenceString = getTimeDifferenceString(postDate);
    const key =data.key;
    console.log(key);

    // Firebase Realtime Databaseã‹ã‚‰ã„ã„ã­ã®æ•°ã‚’å–å¾—
    const likeCountRef = ref(db, `chat/message/${key}/likeCount`);
    get(likeCountRef).then((snapshot) => {
        const likeCount = snapshot.val() || 0; // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯0ã‚’è¨­å®š

    let h = '<div id="'+key+'" class="post">';
       h += '<p>';
       h += `${msg.uname} (${timeDifferenceString})<br>`;

       // ã‚³ãƒ¡ãƒ³ãƒˆãŒé•·ã„å ´åˆã¯ä¸€éƒ¨ã‚’è¡¨ç¤ºã—ã€çœç•¥è¨˜å·ã‚’è¿½åŠ 
        const maxCommentLength = 50; // è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆã®æœ€å¤§æ–‡å­—æ•°
        const truncatedComment = msg.text.length > maxCommentLength ? msg.text.substring(0, maxCommentLength) + "..." : msg.text;
        h += '<span contentEditable="true" id="' + key + '_update">' + truncatedComment + '</span>';

       h += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
       h += `<span class="likeCount" data-key="${key}">${likeCount}</span>`; // Firebaseã‹ã‚‰å–å¾—ã—ãŸã„ã„ã­ã®æ•°ã‚’è¡¨ç¤º
       h += '<button class="reply" data-key="'+key+'">è¿”ä¿¡</button>'; // è¿”ä¿¡ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
       h += '<span class="remove" data-key="'+key+'">ğŸš®</span>'
       h += '<span class="update" data-key="'+key+'">ğŸ†™</span>'
       h += '</p>';
    // ç”»åƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç”»åƒã‚’è¿½åŠ 
    if (msg.imageURL) {
       h += `<img class="myimg" src="${msg.imageURL}">`;
    }
    
    h += '</div>';
    const $message = $(h);
    $("#output").prepend($message);
}).catch((error) => {
        console.error("ã„ã„ã­ã®æ•°ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    });

  
      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $("#uname").val("");
    $("#text").val("");
    $("#fileInput").val("");
    $("#preview").hide();
});

// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é–¢æ•°
function saveDataToLocalStorage(data) {
  localStorage.setItem('coordinates', JSON.stringify(data));
}

// lan, lonãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«æ ¼ç´
const coordinatesArray = [];

onValue(dbRef, (snapshot) => {
  snapshot.forEach((record) => {
    // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ "latitude" ã¨ "longitude" ã®å€¤ã‚’å–å¾—ã—ã€é…åˆ—ã«è¿½åŠ ã—ã¾ã™ã€‚
    const key     =record.key;
    const latitude = record.val().latitude;
    const longitude = record.val().longitude;

    // ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
    console.log(key,latitude, longitude, "ãƒã‚§ãƒƒã‚¯2");

    // é…åˆ—ã«çµŒåº¦ã¨ç·¯åº¦ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚
    coordinatesArray.push({ key,latitude, longitude });
  });

  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã—ã¾ã™ã€‚
  saveDataToLocalStorage(coordinatesArray);
});

   
// å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".remove",function(){
  console.log("å‰Šé™¤ã—ã¾ã™");
  const key =$(this).attr("data-key");
  const remove_item =ref(db,"chat/message/"+key);
  remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
});

// æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click",".update",function(){
  console.log("æ›´æ–°ã—ã¾ã™");
  const key =$(this).attr("data-key");
  update(ref(db,"chat/message/"+key), {
      text:$("#"+key+'_update').html()
  });
});

// å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã„ã„ã­æ•°ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
let likeCounts = {};

// ã„ã„ã­ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
$("#output").on("click", ".likeButton", function() {
    const key = $(this).closest('div.post').attr("id"); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚­ãƒ¼ã‚’å–å¾—

    // ã‚­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèª
    if (key) {
        const likeCountRef = ref(db, "chat/message/" + key + "/likeCount");

        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã„ã­æ•°ã‚’æ›´æ–°
        runTransaction(likeCountRef, (currentLikeCount) => {
            return (currentLikeCount || 0) + 1;
        }).then((transactionResult) => {
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸå ´åˆã®å‡¦ç†
            if (transactionResult.committed) {
                const newLikeCount = transactionResult.snapshot.val();
                // ç”»é¢ä¸Šã«ã„ã„ã­æ•°ã‚’åæ˜ 
                $(this).siblings(".likeCount").text(newLikeCount);
                console.log("ã„ã„ã­ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
            } else {
                console.error("ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒä¸­æ­¢ã•ã‚Œã¾ã—ãŸã€‚");
            }
        }).catch((error) => {
            console.error("ã„ã„ã­ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        });
    } else {
        console.error("ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
});

// ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹éš›ã®å‡¦ç†
// Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®ã„ã„ã­æ•°ã¨åŒæœŸã•ã›ã‚‹
function displayMessages() {
    // Firebase Realtime Databaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const dbRef = ref(getDatabase());
    // å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã„ã„ã­æ•°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    $(".post").each(function() {
        const key = $(this).attr("id");
        const likeCountRef = ref(db, "chat/message/" + key + "/likeCount");
        get(likeCountRef).then((snapshot) => {
            const likeCount = snapshot.val() || 0;
            $(this).find(".likeCount").text(likeCount);
        }).catch((error) => {
            console.error("ã„ã„ã­æ•°ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        });
    });
}



// å‰Šé™¤å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildRemoved(dbRef,(data)=> {
  $("#"+data.key).remove();  //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
})

// æ›´æ–°å‡¦ç†ãŒfirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼
onChildChanged(dbRef,(data)=>{
    const newText = data.val().text || ''; // æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ã€‚ãƒ†ã‚­ã‚¹ãƒˆãŒæœªå®šç¾©ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«ã™ã‚‹
    $("#"+data.key+'_update').html(newText); // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    $("#"+data.key+'_update').fadeOut(800).fadeIn(800); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ
});

// è¿”ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#output").on("click", ".reply", function() {
    // è¡¨ç¤ºå¾Œã®å‡¦ç†
    $("#tsunashima").hide();
    $(".main").hide();  
    $("#replyInput").show();
    $("#output").hide();
    $("#geocode").hide();

    const key = $(this).attr("data-key"); 
    console.log(key,"ãƒãƒ†ãƒŠ");
    localStorage.setItem("pin",key);
    localStorage.getItem("pin",key);
    $("#reply2").attr("data-key", key);

    // Firebase Realtime Databaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const dbRef = ref(getDatabase());

    get(child(dbRef, "chat/message/"+key)).then((snapshot) => {
    if (snapshot.exists()) {
        console.log(snapshot.val());   //snapshotã§åŒã˜ã‚­ãƒ¼ã®è¿”ä¿¡å…¨éƒ¨ã‚’å–å¾—ã—ã¦ãã¦ã„ã‚‹
        const msg = snapshot.val();
        const postDate = new Date(msg.timestamp);
        const timeDifferenceString = getTimeDifferenceString(postDate);

        // å…ƒã®æŠ•ç¨¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º       
        let m = '<div id="${key}" class="post3">';
           m += '<p>';
           m += `${msg.uname} (${timeDifferenceString})<br>`;
           m += `${msg.text}`;
           m += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
           m +=`<span class="likeCount">${msg.likeCount}</span>`; 
        //    m += `<span class="likeCount" data-key="${key}">${msg.likeCount}</span>`; // Firebaseã‹ã‚‰å–å¾—ã—ãŸã„ã„ã­ã®æ•°ã‚’è¡¨ç¤º
           m += '</p>';
        let picture = '';
        if(msg.imageURL) {
           m += `<img src="${msg.imageURL}">`; 
        }
        m += '</div>'
        const $message = $(m);
        $("#replyContainer").html($message);

        //åœ°å›³ã‚’è¡¨ç¤º
     const lat =msg.latitude;
     const lon =msg.longitude;
     console.log(lat,lon,"ãƒã‚§ãƒƒã‚¯");
     const map=new Microsoft.Maps.Map("#myMap",{
        center :new Microsoft.Maps.Location(lat, lon),
        zoom:17,
      });
      let pin = new Microsoft.Maps.Pushpin(map.getCenter(), {
        color:'red',
        draggable:true,
        enableClickedStyle:true,
        enableHoverStyle:true,
        visible:true
      });
      map.entities.push(pin);
    }
   
            // ãã®ä»–ã®è¿”ä¿¡ã®è¡¨ç¤º
            const replyRef = ref(db, `chat/message/${key}/replies`); 
            onChildAdded(replyRef, function(data) {
                const replyData = data.val();
                const postDate = new Date(replyData.timestamp); // Firebaseã‹ã‚‰å–å¾—ã—ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                const timeDifferenceString = getTimeDifferenceString(postDate);
                const replyKey = data.key;
                console.log(replyKey);

                let t = '<div id="'+key+'" class="post2">';
                   t += '<p>';
                   t += `${replyData.uname} (${timeDifferenceString})<br>`;
                   t += '<span contentEditable="true" id="' + key + '_update">' + replyData.text + '</span>';
                   t += '<button class="likeButton"><i class="fas fa-heart"></i></button>';
                //    t += `<span class="likeCount" data-key="${key}">${replyData.likeCount}</span>`; // Firebaseã‹ã‚‰å–å¾—ã—ãŸã„ã„ã­ã®æ•°ã‚’è¡¨ç¤º
                   t += '</p>';
                   t += '</div>';
                const $message = $(t);
                $("#replyContainer").append($message);
   
 
        

     
    });
})

            // è¿”ä¿¡é€ä¿¡ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
$("#reply2").on("click", function() {
    const key = $(this).attr("data-key");
    console.log(key);
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®å–å¾—
    const uname = $("#uname2").val();
    const text = $("#text2").val();
    const replyData = {
        text: text,
        uname: uname,
        timestamp: new Date().getTime(), // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®è¨­å®š
        // likeCount:0
    };

    // Firebase Realtime Databaseã«è¿”ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹
    const replyRef = ref(db, `chat/message/${key}/replies`);
    const newReplyRef = push(replyRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ

    // è¿”ä¿¡ã‚’æŠ•ç¨¿ã®ä¸‹ã«ä¿å­˜ã™ã‚‹
    set(newReplyRef, replyData)
        .then(() => {
            console.log("è¿”ä¿¡ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚");
            // é€ä¿¡æˆåŠŸã®å ´åˆã€é©åˆ‡ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æä¾›ã™ã‚‹ãªã©ã®å‡¦ç†ã‚’è¿½åŠ 

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            $("#uname2").val("");
            $("#text2").val("");
        });
    });

//     // ã„ã„ã­ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†
// $("#replyContainer").on("click", ".likeButton", function() {
//     const key = $(this).attr("data-key"); 
//     console.log(key);

//     // ã‚­ãƒ¼ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèª
//         if (replykey) {
//         // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã„ã­æ•°ã‚’æ›´æ–°
//         runTransaction(likeCountRef, (currentLikeCount) => {
//             return (currentLikeCount || 0) + 1;
//         }).then((transactionResult) => {
//             // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸå ´åˆã®å‡¦ç†
//             if (transactionResult.committed) {
//                 const newLikeCount = transactionResult.snapshot.val();
//                 // ç”»é¢ä¸Šã«ã„ã„ã­æ•°ã‚’åæ˜ 
//                 $(this).siblings(".likeCount").text(newLikeCount);
//                 console.log("ã„ã„ã­ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
//             } else {
//                 console.error("ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒä¸­æ­¢ã•ã‚Œã¾ã—ãŸã€‚");
//             }
//         }).catch((error) => {
//             console.error("ã„ã„ã­ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", error);
//             // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
//         });
//     } else {
//         console.error("ã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
//     }
});
      
// æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ã
$("#return").on("click", function() {
    $(".main").show();
    $("#replyInput").hide();
    $("#tsunashima").show();
    $("#output").show();
});



</script>
<script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=[**MAPKEY**]' async defer></script>
<script src="https://cdn.jsdelivr.net/gh/yamazakidaisuke/BmapQuery/js/BmapQuery.js"></script>
<script>
function GetMap(){
    //------------------------------------------------------------------------
    //1. Instance
    //------------------------------------------------------------------------
    const map = new Bmap("#myMap");
    
    //------------------------------------------------------------------------
    //2. Display Map
    //   startMap(lat, lon, "MapType", Zoom[1~20]);
    //   MapType:[load, aerial,canvasDark,canvasLight,birdseye,grayscale,streetside]
    //--------------------------------------------------
    map.startMap(35.5367225126281, 139.6344014093647, "load", 15);

    //----------------------------------------------------
    //3. Geocode(2 patterns)
    // getGeocode("searchQuery",callback);
    //----------------------------------------------------
    

    
    // //B.Get geocode of click location
    map.onGeocode("click", function(data){
        console.log(data);                   //Get Geocode ObjectData
        // const lat = data.location.latitude;  //Get latitude
        // const lon = data.location.longitude; //Get longitude
         lat = data.location.latitude;  //Get latitude
         lon = data.location.longitude; //Get longitude
        console.log(lat,lon,"ãƒã‚§ãƒƒã‚¯");
        const v ={
            lat: lat,lon:lon
        }
        const vv =JSON.stringify(v)

        localStorage.setItem("map",vv);
       

        document.querySelector("#geocode").innerHTML=lat+','+lon;
        let pin = map.pinIcon(lat, lon, "../img/poi_custom.png", 1.0, 0, 0);
    });


        // // JSONã‹ã‚‰å–å¾—ã—ãŸç·¯åº¦ã¨çµŒåº¦
        // const aa = JSON.parse(localStorage.getItem("map"));
        // const latitude = aa.lat;
        // const longitude = aa.lon;

        // // BmapQueryã‚’ä½¿ç”¨ã—ã¦åœ°å›³ä¸Šã«ãƒ”ãƒ³ã‚’è¿½åŠ ã™ã‚‹
        // function GetMap(){
        // const map = new Bmap("#myMap");
        // map.startMap(latitude, longitude, "load", 15); // ãƒ”ãƒ³ã‚’è¿½åŠ ã™ã‚‹åœ°ç‚¹ã‚’ä¸­å¿ƒã«åœ°å›³ã‚’è¡¨ç¤º
        // const pin = map.pin(latitude, longitude, "#ff0000"); // ãƒ”ãƒ³ã‚’è¿½åŠ 
        // }

        
        const bb =JSON.parse(localStorage.getItem("coordinates"))
        console.log(bb,"ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸");

        for (let i = 0; i < bb.length; i++) {
    const latitude = bb[i].latitude;
    const longitude = bb[i].longitude;
    const key      =bb[i].key;
    
//     let clickedLocation;
//     map.onGeocode("click", function(data) {
//     const lat = data.location.latitude;
//     const lon = data.location.longitude;

//     // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ç·¯åº¦ã¨çµŒåº¦ã‚’ä¿å­˜
//     saveClickedLocation(lat, lon);
// });

// // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’å®šç¾©
// function saveClickedLocation(lat, lon) {
//     clickedLocation = { lat, lon };
// }
    
        let pin = map.pinText(latitude, longitude, "title","subtitle","Click");
       map.onPin(pin, "click", function(){
        localStorage.setItem("pin",key);
        console.log(key);
        $("#replyContainer").show();
        $(".main").hide();  
    $("#replyInput").show();
    $("#output").hide();
    $("#geocode").hide();

    
  
    })
} 

}

    
</script>


</body>
</html> 